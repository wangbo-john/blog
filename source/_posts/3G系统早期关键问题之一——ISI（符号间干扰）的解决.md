---
title: 3G系统早期关键问题之一——ISI（符号间干扰）的解决
author: 王波
authorDesc: 喜读中外经典的架构师，偏又不得闲，所以没看几本
date: 2020-1-31 23:45
cover: "/img/2020/mu_huo_shui_moon_in_a_line.jpg"
categories: 技术
tags:
    - 3G
    - TDD
    - inter-symbol-inteference
    - filter
    - jitter
    - scale
    - quantify-precision

---
<!--more-->




2002年左右，中国向3GPP提交了第一份以中国人为设计者的移动通信协议，TD-SCDMA。
可是国外有很多质疑的声音，最关键的一个问题是，这套协议的瓶颈，
##符号间干扰，中国人能克服吗？
当然实验室里早就验证过了，这里人家问的是工程上。中国人此前连2G芯片都没有设计过，上来就直接要参与3G，能玩得起吗？
最可气的是，老外公开质疑也就算了，中国业界最强大的大佬公司，不好好当它的评委，也跑到公开媒体上不停造势。它一早就认为欧洲标准是它篮子里的菜，觉得这种本土提交的标准怎么也轮不到它来运营，跟在国外大咖身后推波助澜就是在打击将来的竞争对手。这么小的格局真是粉碎了我对它的良好印象，所以几年后事情反转，我偷偷幸灾乐祸了一把。

话说回来，
##为什么人家有这种公开的质疑呢？
移动通讯有几十种信道，3GPP当时有三种标准，其中由欧美掌控的两大标准都使用频分复用的方法来区分信道，也就是在带宽范围内分配不同的频率来区分不同信道。
中国为了有机会参与标准制定，必须和已有标准有比较鲜明的区别，这个特色就是时分复用。中国提交的TD-SCDMA标准里，所有信道都使用同一个频率和带宽，通过切换时间片来切换不同信道，每个时间片的长度是5ms，每隔5ms就会重新审核请求队列里排名靠前的信道是否更有前途，可以把当前信道替换掉。
问题就是这个5ms的时长带来的。
信息由比特组成，每个比特编码调制都会占用一定时长，5ms时长全部给信息编码使用，是效率最高的方式。可是不行啊，3G、4G、5G这种空中信号和噪声差不多，根本无法通过幅度或频率这些古早的信号特征来区分信号的头和尾。
所以5ms长度的信号里有些辅助信号，用来帮助手机确定每段信号的位置和编码方式。
把无线信号想象成一根金箍棒的话，这根金箍棒的中间部分嵌有一小段磁铁。信号接收方用另一块磁铁，从金箍棒上划过（数学上是卷积运算），就能感应到金箍棒上磁铁的位置，进而就可以按约定协议定位到金箍棒，也就是信号的头尾。
可是5ms的时间长度很短，为了提高我们技术标准的竞争力，分配给这些辅助信号的长度就更短了。想象一下金箍棒和你手中磁铁的厚度，一尺厚的磁铁，和薄薄的一片磁铁，哪个更容易定位。
两块磁铁对上后，手中这块磁铁还要做很多动作，通过反馈来确定当年加工金箍棒时的工艺参数（就是确定这段信号编码调制的参数，以便后续信号解调）。
当时，FDD用的就是厚磁铁，因为它没有长度限制；而TDD限制了5ms长度，用的就是薄磁铁片。




雪上加霜的是，在磁铁、金箍棒体结合部分有个过渡区，财大气粗的FDD可以忽略掉这个过渡区，可若是同样厚度的过渡区，TDD却不能忽略，所以TDD其实对于滤波器有更严格的要求。
当时全球市场上最好的模拟基带芯片是米国某公司的一款WCDMA芯片，大家用它的采样数据做仿真，发现留给TD-SCDMA的裕量不多，如果工程上处理不好，TD-SCDMA可能会变成最昂贵的协议：它需要更高的过采样率、更高精度的AD转换、更多的计算单元来做多信道联合检测（其它两标准不需要），最终变成一个面子工程。

##什么是ISI（符号间干扰）
废话半天，还没说到本质：什么是ISI？
符号间干扰有时也称码间干扰，它们是同一个东西啦，只是不同的叫法而已。下面是百度出来的结果。
符号间干扰指的是下面的含义：
（1）在一个数字传输系统中所接收的信号的失真；
（2）在一个或多个电键间隔中的额外信号能量，该能量干扰了在另外一个电键间隔的信号的接收。
一个小区的基站发射出无线信号之后，最理想情况是信号直线路径发送到手机，但是还有些信号在各种建筑物和地形上经过反射、折射路径后才进入手机，甚至会有别的小区信号被接收到，这就是移动通信常见的多径效应。哪怕手机接收到的所有信号中连一路直达的信号也没有，我们也必须挑选出质量靠前的几条路径进行解码。
![符号间干扰](/img/2020/inteference/multi_path_caused_ISI.jpg "ISI")


##信号处理从模拟端开始
我们也用这款WCDMA芯片采样分析，发现它的模拟基带滤波器应该是butterworth，但不够平坦，应该是tuning出来的。
从芯片规格书上得知这颗芯片用的是当年很牛掰的biCMOS工艺。
我们团队的科研牛人于是检索了所有相关论文，只发现很少几篇用biCMOS工艺设计滤波器的论文，无一例外都是手工或机器tuning出结果，说明这个领域还没有理论公式可供使用。
我负责的模块之一就是数字端的匹配滤波器，给我的任务书上指出，这个匹配滤波器的任务就是匹配模拟滤波器，结合起来（数学上是相乘）组成一个带内平滑的butterworth滤波器。我觉得如果模拟基带滤波器不够完美，出来的信号就已失真的话，数字端是无法补偿的。于是决定动手解决模拟滤波器的设计理论问题。失败也不要紧，至少米国公司那么多大牛不也没有解决。
按论文里的几个滤波器结构搭好电路，用仿真器tuning下来，发现其中一种结构得到的曲线和WCDMA芯片滤波器频响特征有点象，于是就基于该电路开始建模。
搭建的电路是基于biCMOS工艺的跨导放大器设计的6阶滤波器，建模得到一个6元12次方程组。连着两天下班后瞪着这个方程组，也没找到任何规律。但是慢慢倾向于最终结果可能是一个类似于maxwell方程的东西。
后来每天只要略有空闲，就拿出来尝试各种解法。计算机手段也用了，matlab，mapple，mathimatics全用过，对于全符号组成的高次方程，它们毫无作用，反倒是在用各种形式输入方程的过程中，有了点灵感，两周后，手工将方程组降阶到了8次方，形式也没开始那么难看。
刚好满一个月的那天，突然灵光一闪，下笔如有神，把6元8次方程组一顿变换，变成一个圆锥曲线加上n个固定公式的形式。如果让圆锥曲线成为正圆，得到的就是butterworth滤波器，成为其它曲线，也能得到相应特性的滤波器。n个公式的个数由滤波器阶数决定。
回头再看电路，在公式帮助下有了很深的领悟，这个方程组可以解决所有跨导放大器滤波器的问题。
我们老板就是从那家米国公司出来的，他很高兴地和前同事们联系，把我们的新理论告诉了他们，于是我们被邀请去米国交流，实则游玩了一圈。
最关键的是，那家米国公司同意给我们生产TD-SCDMA版本的模拟基带芯片，即1.6MHz带宽的版本。
解决模拟滤波器问题之前，我们要想解码WCDMA芯片采样得到的TD信号，至少需要8倍过采样，10bit量化。早期的TD研究如果不是纯计算机仿真，基本都是这种甚至更高的参数配置。
仅仅一个滤波器的升级，就可以用9bit的量化值，得到比原来10bit信号更高的信噪比。


##并行计算
降低了模拟输入信号失真程度后，下一步我要解决两个符号之间的额外能量问题。
TD系统有使用滚降系数0.22的升余弦滤波器，理论上可以过滤掉带外的残余能量。但这是在实验室静态环境下的结果，实际的无线通讯中，基站与手机使用不同的时钟源，它们之间的频率和稳定特性都不一样，另外移动中的手机还有多普勒效应，造成频移，所以额外能量的来源，主要是基站和手机间这种频率差异造成的抖动引起的。
我的另一模块是自动频率控制（AFC），就是让手机自身频率和漂移特性都保持和基站相同。
基站时钟频率是通过一定的算法，计算接收信号得到的。算出基站频率后又有另一套算法来调整手机自身，将频率跟上去。
可是信号在空中会有很多传输途径，有的直线直接传到手机，有的在建筑物上经过一次或多次反射、折射后进入手机，有的是这个小区信号，有的是相邻小区信号。
这么多的信号，我们需要分析出哪几条是我们想要的。
当时的计算机是单核的，arm芯片是单核的，几乎所有微控制器都是单核的，包括我们的算法，也是单线程的，总是先计算完一个结果，再去处理下一次计算。
为了提高效率，通常都要提高工作频率。
手机芯片为了省电，拼命想办法降频。
可是很多条信道的分析结果又要尽快计算出来。
比如在小区间切换时，需要同时跟踪至少两个小区的信号，此时如果计算及时，很大程度上能提高小区切换的成功率。
于是我在AFC里增加卷积单元，让芯片并行计算，这样可以在不影响其它模块功耗的情况下，得到需要的运算速度。
如果



